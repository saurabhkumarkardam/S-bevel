##############################################################################################
#  Copyright Accenture. All Rights Reserved.
#
#  SPDX-License-Identifier: Apache-2.0
##############################################################################################

##############################################################################################
# This role checks for validation of network.yaml
# Conditions to be checked
# At least 4 genesis stewards
# Max 1 trustee per org
# Max 1 endorser per org
# At least one trustee per network.yaml
##############################################################################################

# Set variables
- name: Set counters
  set_fact:
    total_stewards=0
    total_trustee=0
    total_endorser=0

##############################################################################################
# # Check Validation
# - name: "Check Validation"
#   include_tasks: check_count.yaml
#   vars:
#     trustees: "{{ organizationItem.services.trustee|default([]) }}"
#     endorsers: "{{ organizationItem.services.endorser|default([]) }}"
#     stewards:  "{{ organizationItem.services.stewards|default([]) }}"
#   loop: "{{ network['organizations'] }}"
#   loop_control:
#     loop_var: organizationItem

# # Print error and end playbook if genesis steward count limit fails
# - name: Print error and end playbook if genesis steward count limit fails
#   debug: msg="The total genesis steward count is {{ total_stewards }}. There should be at least 4 genesis stewards (in case of a fully Hyperledger Bevel-managed cluster)."
#   failed_when: not add_new_org and total_stewards|int < 4

# # Print error and end playbook if total trustee count limit fails
# - name: Print error and end playbook if total trustee count limit fails
#   debug: msg="The total trustee count is {{ total_trustees }}. There should be at least 1 trustee per network (in case of a fully Hyperledger Bevel-managed cluster)."
#   failed_when: not add_new_org and total_trustees|int < 1
##############################################################################################

# Loop through each organization to count nodes
- name: Count nodes
  include_tasks: check_count.yaml
  vars:
    peers: "{{ item.services.peers }}"
  loop: "{{ network['organizations'] }}"
  loop_control:
    loop_var: org

##############################################################################################
- name: "MASTER --- Debug counts"
  debug:
    msg: "Total stewards: {{ total_stewards }}, Total trustee: {{ total_trustee }}, Total endorsers: {{ total_endorser }}"
##############################################################################################

- name: Stop execution if total trustee is not equal to 1
  fail:
    msg: "Exactly 1 trustee is required per indy network."
  when: (total_trustee | int) != 1

- name: Stop execution if total endorser is not equal to 1
  fail:
    msg: "Exactly 1 endorser is required per indy network."
  when: (total_endorser | int) != 1

- name: Stop execution if total stewards are less than 4
  fail:
    msg: "At least 4 stewards are required per indy network."
  when: (total_stewards | int) < 4
